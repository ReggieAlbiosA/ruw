#!/bin/bash
# ruw - Reggie Ubuntu Workspace CLI
# Manage workspace setup from anywhere

set -e

# ============================================
# Colors
# ============================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m'

# ============================================
# Config
# ============================================
VERSION="1.0.0"
CONFIG_DIR="$HOME/.config/ruw"
WORKSPACE_PATH_FILE="$CONFIG_DIR/workspace-path"
EXPECTED_REMOTE="https://github.com/ReggieAlbiosA/reggie-ubuntu-workspace.git"

# ============================================
# Workspace Discovery
# ============================================
find_workspace() {
    # 1. Check cached path first
    if [ -f "$WORKSPACE_PATH_FILE" ]; then
        local cached_path=$(cat "$WORKSPACE_PATH_FILE")
        if [ -d "$cached_path" ] && [ -f "$cached_path/setup.sh" ]; then
            # Verify it's the correct repo
            if cd "$cached_path" 2>/dev/null && git remote get-url origin 2>/dev/null | grep -q "$EXPECTED_REMOTE"; then
                echo "$cached_path"
                return 0
            fi
        fi
    fi

    # 2. Search common locations
    local search_paths=(
        "$HOME/Documents/reggie-ubuntu-workspace"
        "$HOME/reggie-ubuntu-workspace"
        "$HOME/workspace/reggie-ubuntu-workspace"
        "$HOME/dev/reggie-ubuntu-workspace"
        "$HOME/projects/reggie-ubuntu-workspace"
    )

    for path in "${search_paths[@]}"; do
        if [ -d "$path/.git" ] && [ -f "$path/setup.sh" ]; then
            if cd "$path" 2>/dev/null && git remote get-url origin 2>/dev/null | grep -q "$EXPECTED_REMOTE"; then
                # Cache for next time
                mkdir -p "$CONFIG_DIR"
                echo "$path" > "$WORKSPACE_PATH_FILE"
                echo "$path"
                return 0
            fi
        fi
    done

    # Not found
    return 1
}

# ============================================
# Action Handlers
# ============================================
do_local_update() {
    echo -e "${CYAN}ruw: Finding workspace...${NC}"

    local workspace_path
    if ! workspace_path=$(find_workspace); then
        echo -e "${RED}Error: Could not find reggie-ubuntu-workspace${NC}"
        echo -e "${YELLOW}Searched locations:${NC}"
        echo "  - ~/Documents/reggie-ubuntu-workspace"
        echo "  - ~/reggie-ubuntu-workspace"
        echo "  - ~/workspace/reggie-ubuntu-workspace"
        echo "  - ~/dev/reggie-ubuntu-workspace"
        echo "  - ~/projects/reggie-ubuntu-workspace"
        echo ""
        echo -e "${CYAN}Please ensure the workspace is cloned to one of these locations.${NC}"
        exit 1
    fi

    echo -e "${GREEN}Found workspace: $workspace_path${NC}"
    echo -e "${CYAN}Running setup.sh ${SETUP_FLAGS[*]}${NC}\n"

    cd "$workspace_path"
    bash setup.sh "${SETUP_FLAGS[@]}"
}

show_help() {
    echo -e "${WHITE}ruw - Reggie Ubuntu Workspace CLI${NC}"
    echo -e "${CYAN}Version $VERSION${NC}"
    echo ""
    echo "Usage:"
    echo "  ruw --local-update [options]    Update workspace locally"
    echo "  ruw --help                      Show this help"
    echo "  ruw --version                   Show version"
    echo ""
    echo "Options (pass through to setup.sh):"
    echo "  -y, --yes                       Auto-accept all prompts"
    echo "  --skip-optional                 Skip optional modules"
    echo "  --defaults-only                 Same as --skip-optional"
    echo ""
    echo "Examples:"
    echo "  ruw --local-update              Interactive update"
    echo "  ruw --local-update -y           Auto-accept all prompts"
    echo "  ruw --local-update --skip-optional    Update core only"
}

show_version() {
    echo "ruw version $VERSION"
}

# ============================================
# Argument Parsing
# ============================================
ACTION=""
SETUP_FLAGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --local-update)
            ACTION="local-update"
            shift
            ;;
        --help|-h)
            ACTION="help"
            shift
            ;;
        --version|-v)
            ACTION="version"
            shift
            ;;
        -y|--yes|--skip-optional|--defaults-only)
            # Pass through to setup.sh
            SETUP_FLAGS+=("$1")
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Run 'ruw --help' for usage"
            exit 1
            ;;
    esac
done

# ============================================
# Main Execution
# ============================================
if [ -z "$ACTION" ]; then
    echo -e "${RED}Error: No action specified${NC}"
    echo "Run 'ruw --help' for usage"
    exit 1
fi

case $ACTION in
    local-update)
        do_local_update
        ;;
    help)
        show_help
        ;;
    version)
        show_version
        ;;
esac
